<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login / Sign Up</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }
        .auth-card {
            max-width: 400px;
            width: 90%;
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="auth-card">
        <h2 class="text-3xl font-extrabold text-center text-indigo-600 mb-2" id="auth-title">Sign In</h2>
        <p class="text-center text-gray-500 mb-6" id="auth-subtitle">Welcome back!</p>

        <form id="auth-form" class="space-y-4">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="email" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="password" required class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div id="username-group" class="hidden">
                <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                <input type="text" id="username" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Choose a username">
            </div>
            
            <button type="submit" id="auth-button" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150">
                Sign In
            </button>
        </form>

        <p class="mt-6 text-center text-sm">
            <button id="toggle-auth" class="font-medium text-indigo-600 hover:text-indigo-500">
                Need an account? Sign Up
            </button>
        </p>

        <!-- Status/Error Message Box -->
        <div id="message" class="mt-4 p-3 text-center text-sm rounded-md hidden"></div>
    </div>

    <script type="module">
        // Import Firebase components
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword,
            onAuthStateChanged,
            setLogLevel 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Enable Firebase debug logging
        setLogLevel('Debug');

        // --- Constants ---
        const DEFAULT_PFP_URL = 'https://tse2.mm.bing.net/th/id/OIP.hWCgoIQsOnv4fHroWUVl7AHaHa?rs=1&pid=ImgDetMain&o=7&rm=3';
        const APP_ID = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const FIREBASE_CONFIG = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

        // --- DOM Elements ---
        const authForm = document.getElementById('auth-form');
        const toggleAuthBtn = document.getElementById('toggle-auth');
        const authTitle = document.getElementById('auth-title');
        const authSubtitle = document.getElementById('auth-subtitle');
        const authButton = document.getElementById('auth-button');
        const usernameGroup = document.getElementById('username-group');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const usernameInput = document.getElementById('username');
        const messageEl = document.getElementById('message');

        // --- Global State ---
        let isSigningUp = false;
        let db, auth;
        
        // --- Firebase Initialization ---
        try {
            const app = initializeApp(FIREBASE_CONFIG);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase initialized successfully.");
        } catch (error) {
            console.error("Firebase initialization failed:", error);
            showMessage('Error initializing application.', true);
        }

        // --- Utility Functions ---
        function showMessage(text, isError = false) {
            messageEl.textContent = text;
            messageEl.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
            if (isError) {
                messageEl.classList.add('bg-red-100', 'text-red-700');
            } else {
                messageEl.classList.add('bg-green-100', 'text-green-700');
            }
            authButton.disabled = false;
            authButton.textContent = isSigningUp ? 'Sign Up' : 'Sign In';
        }

        function toggleAuthMode() {
            isSigningUp = !isSigningUp;
            if (isSigningUp) {
                authTitle.textContent = 'Sign Up';
                authSubtitle.textContent = 'Create your new account.';
                authButton.textContent = 'Sign Up';
                toggleAuthBtn.textContent = 'Already have an account? Sign In';
                usernameGroup.classList.remove('hidden');
                usernameInput.setAttribute('required', 'required');
            } else {
                authTitle.textContent = 'Sign In';
                authSubtitle.textContent = 'Welcome back!';
                authButton.textContent = 'Sign In';
                toggleAuthBtn.textContent = 'Need an account? Sign Up';
                usernameGroup.classList.add('hidden');
                usernameInput.removeAttribute('required');
            }
            messageEl.classList.add('hidden');
        }

        async function createProfile(userId, username) {
            // 1. Private profile data
            const privateProfileRef = doc(db, `artifacts/${APP_ID}/users/${userId}/profile/data`);
            await setDoc(privateProfileRef, {
                username: username,
                pfpUrl: DEFAULT_PFP_URL,
                createdAt: new Date().toISOString()
            });

            // 2. Public profile copy (for user discovery in the dashboard)
            const publicProfileRef = doc(db, `artifacts/${APP_ID}/public/data/public_profiles/${userId}`);
            await setDoc(publicProfileRef, {
                username: username,
                pfpUrl: DEFAULT_PFP_URL,
                lastActive: new Date().toISOString()
            }, { merge: true });
        }


        // --- Event Listeners ---
        toggleAuthBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggleAuthMode();
        });

        authForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            authButton.disabled = true;
            authButton.textContent = isSigningUp ? 'Signing Up...' : 'Signing In...';
            messageEl.classList.add('hidden');

            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            const username = usernameInput.value.trim() || 'User';

            try {
                let userCredential;
                if (isSigningUp) {
                    if (!username) {
                        showMessage('Please enter a username.', true);
                        return;
                    }
                    userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await createProfile(userCredential.user.uid, username);
                    showMessage('Sign up successful! Redirecting...', false);
                } else {
                    userCredential = await signInWithEmailAndPassword(auth, email, password);
                    showMessage('Sign in successful! Redirecting...', false);
                }

                // --- REDIRECT TO CHATROOM.HTML ON SUCCESS ---
                setTimeout(() => {
                    window.location.href = 'chatroom.html';
                }, 1000);

            } catch (error) {
                console.error("Authentication Error:", error);
                let errorMessage = 'An unknown error occurred.';
                if (error.code) {
                    // Firebase specific error codes
                    errorMessage = error.message.replace('Firebase: ', '');
                }
                showMessage(errorMessage, true);
            }
        });
        
        // Check if user is already signed in (prevents flashing or re-logging)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                 // --- REDIRECT TO CHATROOM.HTML IF ALREADY SIGNED IN ---
                console.log("User already signed in. Redirecting to chatroom.html");
                window.location.href = 'chatroom.html';
            }
        });

    </script>
</body>
</html>
